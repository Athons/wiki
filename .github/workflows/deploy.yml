name: Deploy
on:
  push:
    branches:
      - master
  repository_dispatch:
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@main
    - name: Use up to date submodules
      uses: srt32/git-actions@v0.0.3
      with:
        args: git submodule update --init --remote --merge
    - name: Build
      uses: ./.github/actions/mkdocs-build-action
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v2
      with:
        name: site
        path: site

  deploy-wiki:
    name: Deploy hackathons.wiki
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v2
        with:
          name: site
      - name: Write CNAME
        run: echo hackathons.wiki > ./CNAME
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v2.5.0
        env:
          EXTERNAL_REPOSITORY: hackathons-uk/wiki-site
          ACTIONS_DEPLOY_KEY: ${{ secrets.WIKI_SITE_DEPLOY_KEY }}
          PUBLISH_BRANCH: main
          PUBLISH_DIR: ./

  deploy-athon:
    name: Deploy hack.athon.uk
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v2
        with:
          name: site
      - name: Write CNAME
        run: echo hack.athon.uk > ./CNAME
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v2.5.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUBLISH_BRANCH: gh-pages
          PUBLISH_DIR: ./
